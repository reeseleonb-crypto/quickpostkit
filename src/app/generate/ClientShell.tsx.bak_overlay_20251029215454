"use client";

import { useEffect, useMemo, useState } from "react";
import { useSearchParams } from "next/navigation";

type Form = {
  niche: string;
  audience: string;
  product_or_service: string;
  primary_platform: string;
  tone: string;
  video_comfort: string;
  monthly_goal: string;
  content_balance: number;
  hashtag_style: string;
  location: string;
  special_instructions: string;
};

const DEFAULT_FORM: Form = {
  niche: "",
  audience: "",
  product_or_service: "",
  primary_platform: "",
  tone: "",
  video_comfort: "",
  monthly_goal: "",
  content_balance: 50,
  hashtag_style: "balanced",
  location: "",
  special_instructions: "",
};

const PLATFORMS = ["Instagram", "TikTok", "Facebook", "LinkedIn", "YouTube"];
const VIDEO_COMFORT = ["Camera shy", "Somewhat comfortable", "Confident on camera"];
const HASHTAG_STYLES = [
  { value: "balanced", label: "Balanced (38 niche + brand)" },
  { value: "niche-heavy", label: "Niche-heavy" },
  { value: "brand-heavy", label: "Brand-heavy" },
];

export default function ClientShell() {
  const sp = useSearchParams();
  const sessionId = sp.get("session_id");

  const [form, setForm] = useState<Form>(DEFAULT_FORM);
  const [busy, setBusy] = useState<null | { stage: "checking" | "generating" | "downloading"; note?: string }>(null);
  const [error, setError] = useState<string | null>(null);

  // Auto-verify + auto-generate when returning from Stripe
  useEffect(() => {
    const go = async () => {
      if (!sessionId) return;
      setBusy({ stage: "checking" });
      setError(null);
      try {
        const r = await fetch("/api/verify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session_id: sessionId }),
        });
        if (!r.ok) throw new Error("Verification failed");
        const data = await r.json();
        if (!data?.verified) throw new Error("Payment not verified");
        await onGenerate();
      } catch (e: any) {
        setBusy(null);
        setError(e?.message || "Verification error");
      }
    };
    go();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [sessionId]);

  const onChange = (k: keyof Form, v: any) => setForm((prev) => ({ ...prev, [k]: v }));

  const disabled = useMemo(() => {
    return !form.niche || !form.audience || !form.product_or_service || !form.primary_platform;
  }, [form]);

  const onCheckout = async () => {
    setError(null);
    setBusy({ stage: "checking", note: "Redirecting to Stripe Checkout" });
    try {
      const r = await fetch("/api/checkout", { method: "POST" });
      if (!r.ok) throw new Error("Checkout failed");
      const { url } = await r.json();
      if (!url) throw new Error("No checkout URL returned");
      window.location.href = url;
    } catch (e: any) {
      setBusy(null);
      setError(e?.message || "Checkout error");
    }
  };

  const onGenerate = async () => {
    setError(null);
    setBusy({ stage: "generating" });
    try {
      const r = await fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(form),
      });
      if (!r.ok) throw new Error("Generate failed");
      setBusy({ stage: "downloading" });
      const blob = await r.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "QuickPostKit_30_Day_Kit.docx";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
      setBusy(null);
    } catch (e: any) {
      setBusy(null);
      setError(e?.message || "Generation error");
    }
  };

  return (
    <main className="min-h-screen bg-slate-900 text-slate-100">
      <div className="mx-auto max-w-4xl">
        <div className="rounded-2xl border border-white/10 bg-white/5 p-6 md:p-8 backdrop-blur supports-[backdrop-filter]:bg-white/5">
          <div className="mb-6">
            <h1 className="text-3xl md:text-4xl font-semibold text-white">Generate Your 30-Day Social Content Kit</h1>
            <p className="mt-2 text-sm text-slate-300">
              Fill in the details below. When you click <b>Generate</b>, your DOCX will download automatically.
              <span className="ml-2">No subscriptions, no logins â€” just one-time $5.</span>
            </p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
              <label className="block text-sm font-medium text-slate-200 mb-1">Niche</label>
              <input
                className="w-full rounded-xl bg-white/10 border border-white/15 px-4 py-2 text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
                placeholder="e.g., power washing"
                value={form.niche}
                onChange={(e) => onChange("niche", e.target.value)}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-200 mb-1">Audience</label>
              <input
                className="w-full rounded-xl bg-white/10 border border-white/15 px-4 py-2 text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
                placeholder="e.g., homeowners"
                value={form.audience}
                onChange={(e) => onChange("audience", e.target.value)}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-200 mb-1">Product or Service</label>
              <input
                className="w-full rounded-xl bg-white/10 border border-white/15 px-4 py-2 text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
                placeholder="e.g., driveway cleaning"
                value={form.product_or_service}
                onChange={(e) => onChange("product_or_service", e.target.value)}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-200 mb-1">Primary Platform</label>
              <select
                className="w-full rounded-xl bg-white/10 border border-white/15 px-4 py-2 text-slate-100 focus:outline-none focus:ring-2 focus:ring-fuchsia-400 appearance-none pr-9"
                value={form.primary_platform}
                onChange={(e) => onChange("primary_platform", e.target.value)}
              >
                <option value="">(select)</option>
                {PLATFORMS.map((p) => (
                  <option key={p} value={p}>
                    {p}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-200 mb-1">Tone</label>
              <input
                className="w-full rounded-xl bg-white/10 border border-white/15 px-4 py-2 text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
                placeholder="e.g., witty, direct, professional"
                value={form.tone}
                onChange={(e) => onChange("tone", e.target.value)}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-200 mb-1">Video Comfort</label>
              <select
                className="w-full rounded-xl bg-white/10 border border-white/15 px-4 py-2 text-slate-100 focus:outline-none focus:ring-2 focus:ring-fuchsia-400 appearance-none pr-9"
                value={form.video_comfort}
                onChange={(e) => onChange("video_comfort", e.target.value)}
              >
                <option value="">(select)</option>
                {VIDEO_COMFORT.map((v) => (
                  <option key={v} value={v}>
                    {v}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-200 mb-1">Monthly Goal</label>
              <input
                className="w-full rounded-xl bg-white/10 border border-white/15 px-4 py-2 text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
                placeholder="e.g., bookings, sales, email signups"
                value={form.monthly_goal}
                onChange={(e) => onChange("monthly_goal", e.target.value)}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-200 mb-1">
                Content Balance <span className="text-slate-400">(education vs promo)</span>
              </label>
              <input
                type="range"
                min={0}
                max={100}
                step={1}
                className="w-full"
                value={form.content_balance}
                onChange={(e) => onChange("content_balance", Number(e.target.value))}
              />
              <div className="mt-1 text-sm text-slate-400">{form.content_balance}% educational</div>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-200 mb-1">Hashtag Style</label>
              <select
                className="w-full rounded-xl bg-white/10 border border-white/15 px-4 py-2 text-slate-100 focus:outline-none focus:ring-2 focus:ring-fuchsia-400 appearance-none pr-9"
                value={form.hashtag_style}
                onChange={(e) => onChange("hashtag_style", e.target.value)}
              >
                {HASHTAG_STYLES.map((h) => (
                  <option key={h.value} value={h.value}>
                    {h.label}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-200 mb-1">Location</label>
              <input
                className="w-full rounded-xl bg-white/10 border border-white/15 px-4 py-2 text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
                placeholder="e.g., Wilmington, NC"
                value={form.location}
                onChange={(e) => onChange("location", e.target.value)}
              />
            </div>
            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-slate-200 mb-1">Special Instructions</label>
              <textarea
                className="min-h-[110px] w-full rounded-xl bg-white/10 border border-white/15 px-4 py-2 text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-fuchsia-400 resize-vertical"
                placeholder="Anything you want us to emphasize or avoid?"
                value={form.special_instructions}
                onChange={(e) => onChange("special_instructions", e.target.value)}
              />
            </div>
          </div>

          {error && <p className="mt-4 text-sm text-red-300">{error}</p>}

          <div className="mt-8 flex flex-col md:flex-row items-center gap-4">
            {!sessionId && (
              <button
                onClick={onCheckout}
                className="inline-flex items-center justify-center rounded-2xl bg-gradient-to-r from-fuchsia-500 to-pink-500 px-5 py-3 font-semibold text-white shadow-lg hover:from-fuchsia-400 hover:to-pink-400 focus:outline-none focus:ring-2 focus:ring-fuchsia-300"
              >
                Buy for $5
              </button>
            )}
            {sessionId && (
              <button
                onClick={onGenerate}
                disabled={disabled || !!busy}
                className="inline-flex items-center justify-center rounded-2xl bg-gradient-to-r from-fuchsia-500 to-pink-500 px-5 py-3 font-semibold text-white shadow-lg hover:from-fuchsia-400 hover:to-pink-400 disabled:opacity-60 focus:outline-none focus:ring-2 focus:ring-fuchsia-300"
              >
                Generate Now
              </button>
            )}
            <a href="/" className="text-slate-200 hover:text-white underline underline-offset-4">
              Back to Home
            </a>
          </div>

          <p className="mt-3 text-sm text-slate-300">
            Payments handled by Stripe. We don&apos;t store your payment details.
          </p>
        </div>

        {busy && (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div className="max-w-md w-full rounded-2xl border border-white/10 bg-white/5 p-6 text-center backdrop-blur">
              <h2 className="text-xl font-semibold text-white mb-2">
                {busy.stage === "checking" && "Checking payment"}
                {busy.stage === "generating" && "Generating your DOCX"}
                {busy.stage === "downloading" && "Preparing download"}
              </h2>
              <p className="text-sm text-slate-300">
                This may take up to 3 minutes. Please don&apos;t close this tab.
                {busy.note ? " " + busy.note : null}
              </p>
              <div className="mt-5 animate-pulse text-slate-300"></div>
            </div>
          </div>
        )}
      </div>
    </main>
  );
}
